CSKF = MSKF/VSKF  #interstitial fluid concentration
CSKT = MSKT/VSKT # tissue concentration
#Cfree calculation using the expression of free fraction ff
CBfart = CBart * 1.0 / (1.0 + CalbB * Ka)
CBfven= CBven * 1.0 / (1.0 + CalbB * Ka)
CLNf = CLN * 1.0 / (1.0 + CalbB * Ka)  # find albumin concentration in Lymph Nodes
#Calculation of free concentrations in organ blood
CKBf = CKB * 1.0 / (1.0 + CalbB * Ka)
CLBf = CLB * 1.0 / (1.0 + CalbB * Ka)
CSTBf = CSTB * 1.0 / (1.0 + CalbB * Ka)
CINBf = CINB * 1.0 / (1.0 + CalbB * Ka)
CMBf = CMB * 1.0 / (1.0 + CalbB * Ka)
CABf = CAB * 1.0 / (1.0 + CalbB * Ka)
CRBf = CRB * 1.0 / (1.0 + CalbB * Ka)
CLuBf = CLuB * 1.0 / (1.0 + CalbB * Ka)
CSPBf = CSPB * 1.0 / (1.0 + CalbB * Ka)
CHBf = CHB * 1.0 / (1.0 + CalbB * Ka)
CBrBf = CBrB * 1.0 / (1.0 + CalbB * Ka)
CTBf = CTB * 1.0 / (1.0 + CalbB * Ka)
CSKBf = CSKB * 1.0 / (1.0 + CalbB * Ka)
#Calculation of free concentrations in organ interstitial fluid
CKFf = CKF * 1.0 / (1.0 + CalbKF * Ka)
CLFf = CLF * 1.0 / (1.0 + CalbLF * Ka)
CSTFf = CSTF * 1.0 / (1.0 + CalbSTF * Ka)
CINFf = CINF * 1.0 / (1.0 + CalbINF * Ka)
CMFf = CMF * 1.0 / (1.0 + CalbMF * Ka)
CAFf = CAF * 1.0 / (1.0 + CalbAF * Ka)
CRFf = CRF * 1.0 / (1.0 + CalbRF * Ka)
CLuFf = CLuF * 1.0 / (1.0 + CalbLuF * Ka)
CSPFf = CSPF * 1.0 / (1.0 + CalbSPF * Ka)
CHFf = CHF * 1.0 / (1.0 + CalbHF * Ka)
CBrFf = CBrF * 1.0 / (1.0 + CalbBrF * Ka)
CTFf = CTF * 1.0 / (1.0 + CalbTF * Ka)
CSKFf = CSKF * 1.0 / (1.0 + CalbSKF * Ka)
#Calculation of free concentrations in organ where we have tissue binding
CKTf = CKT * 1.0 / (1.0 + Ca2uKT * Ka2u + CLfabpKT * KLfabp)
CLTf = CLT * 1.0 / (1.0 + CLfabpLT * KLfabp)
QBLtot = QBL + (QBSP-QBSP/500) + (QBIN-QBIN/500) + (QBST-QBST/500)
#Arterial Blood
dMBart = (QBLu-QBLu/500)*CLuBf - CBfart*(QBK+QBL+QBM+QBA+QBR+QBSP+QBH+QBBr+QBST+QBIN+QBT+QBSK)-QGFR*CBfart
#Venous Blood
dMBven = - CBfven *QBLu +  CLNf*(QBK/500+QBLtot/500+QBM/500+QBA/500+QBR/500+QBLu/500+QBH/500+QBBr/500+QBT/500+QBSK/500+
QBST/500+QBSP/500+QBIN/500)+
(QBK-QBK/500)*CKBf + (QBLtot-QBLtot/500)*CLBf +
(QBM-QBM/500)*CMBf + (QBA-QBA/500)*CABf + (QBR-QBR/500)*CRBf+
(QBH-QBH/500)*CHBf + (QBBr-QBBr/500)*CBrBf+
(QBT-QBT/500)*CTBf + (QBSK-QBSK/500)*CSKBf
#Lymph nodes
dMLN = CKFf*QBK/500 + CLFf*QBLtot/500 + CMFf*QBM/500 + CAFf*QBA/500+
CRFf*QBR/500 + CLuFf*QBLu/500 + CHFf*QBH/500 + CBrFf*QBBr/500+
CTFf*QBT/500 + CSKFf*QBSK/500 + CSTFf*QBST/500 + CINFf*QBIN/500 + CSPFf*QBSP/500-
CLNf*(QBK/500+QBLtot/500+QBM/500+QBA/500+QBR/500+QBLu/500+QBH/500+QBBr/500+QBT/500+QBSK/500+
QBST/500+QBSP/500+QBIN/500)
#Kidney
#blood subcompartment
dMBK = QBK*CBfart - (QBK-QBK/500)*CKBf - PeffK*AK*(CKBf-CKFf) - CKBf*QBK/500
#interstitial fluid subcompartment
dMKF = CKBf*QBK/500 - CKFf*QBK/500 + PeffK*AK*(CKBf-CKFf) - kKFKT*(CKFf-CKTf) -
(VmK_Oat1*CKFf/KmK_Oat1+CKFf)*VKF - (VmK_Oat3*CKFf/KmK_Oat3+CKFf)*VKF #+ (VmK_Osta*CKTf/KmK_Osta+CKTf)
#Kidney proximal tubule cells subcompartment
dMKT = kKFKT*(CKFf-CKTf) - kFKT*(CKTf - CFil) + (VmK_Oatp*CFil/KmK_Oatp+CFil)*VFil +
(VmK_Oat1*CKFf/KmK_Oat1+CKFf)*VKF + (VmK_Oat3*CKFf/KmK_Oat3+CKFf)*VKF # + (VmK_Osta*CKTf/KmK_Osta+CKTf)
dMFil =  QGFR*CBfart+ kFKT*(CKTf - CFil) - (VmK_Oatp*CFil/KmK_Oatp+CFil)*VFil - (Qurine/VFil)*CFil
dMurine = (Qurine/VFil)*CFil
#Liver
#blood subcompartment
dMBL = QBL*CBfart + (QBSP-QBSP/500)*CSPBf + (QBIN-QBIN/500)*CINBf + (QBST-QBST/500)*CSTBf - PeffL*AL*(CLBf-CLFf) - CLBf*QBLtot/500 - (QBLtot-QBLtot/500)*CLBf
#interstitial fluid subcompartment
dMLF = CLBf*QBLtot/500 - CLFf*QBLtot/500 + PeffL*AL*(CLBf-CLFf) - kLFLT*(CLFf-CLTf) -
(VmL_Oatp*CLFf/KmL_Oatp+CLFf)*VLF - (VmL_Ntcp*CLFf/KmL_Ntcp+CLFf)*VLF
#Liver tissue subcompartment
dMLT = kLFLT*(CLFf-CLTf) + (VmL_Oatp*CLFf/KmL_Oatp+CLFf)*VLF +
(VmL_Ntcp*CLFf/KmL_Ntcp+CLFf)*VLF - kbileLT*(CLTf-Cbile)
dMbile = kbileLT*(CLTf-Cbile) - (Qbile/Vbile)*Cbile
# Feces
dMfeces = (Qfeces/VINL)*CINL
#Stomach
#blood subcompartment
dMBST = QBST*CBfart - (QBST-QBST/500)*CSTBf - PeffST*AST*(CSTBf-CSTFf) - CSTBf*QBST/500
#interstitial fluid subcompartment
dMSTF = CSTBf*QBST/500 - CSTFf*QBST/500 + PeffST*AST*(CSTBf-CSTFf) - kSTFSTT*(CSTFf-CSTT)
#Stomach tissue subcompartment
dMSTT = kSTFSTT*(CSTFf-CSTT) + kabST*CSTL
#Stomach lumen
dMSTL = -kabST*CSTL - QGE*CSTL
#Intestine
#blood subcompartment
dMBIN = QBIN*CBfart - (QBIN-QBIN/500)*CINBf - PeffIN*AIN*(CINBf-CINFf) - CINBf*QBIN/500
#interstitial fluid subcompartment
dMINF = CINBf*QBIN/500 - CINFf*QBIN/500 + PeffIN*AIN*(CINBf-CINFf) - kINFINT*(CINFf-CINT)
#Intestine tissue subcompartment
dMINT = kINFINT*(CINFf-CINT) + kabIN*CINL
#Intestine lumen
dMINL = QGE*CSTL - (Qfeces/VINL)*CINL - kabIN*CINL + (Qbile/Vbile)*Cbile
#Muscle
#blood subcompartment
dMBM = QBM*CBfart - (QBM-QBM/500)*CMBf - PeffM*AM*(CMBf-CMFf) - CMBf*QBM/500
#interstitial fluid subcompartment
dMMF = CMBf*QBM/500 - CMFf*QBM/500 +PeffM*AM*(CMBf-CMFf) - kMFMT*(CMFf- CMT)
#Muscle tissue subcompartment
dMMT = kMFMT*(CMFf- CMT)
#Adipose
#blood subcompartment
dMBA = QBA*CBfart - (QBA-QBA/500)*CABf - PeffA*AA*(CABf-CAFf) - CABf*QBA/500
#interstitial fluid subcompartment
dMAF = CABf*QBA/500 - CAFf*QBA/500 +  PeffA*AA*(CABf-CAFf) - kAFAT*(CAFf-CAT)
#Adipose tissue subcompartment
dMAT =  kAFAT*(CAFf-CAT)
#Rest of body
#blood subcompartment
dMBR = QBR*CBfart - (QBR-QBR/500)*CRBf - PeffR*AR*(CRBf-CRFf) - CRBf*QBR/500
#interstitial fluid subcompartment
dMRF = CRBf*QBR/500 - CRFf*QBR/500 + PeffR*AR*(CRBf-CRFf) - kRFRT*(CRFf -CRT)
#Rest of body tissue subcompartment
dMRT = kRFRT*(CRFf -CRT)
#Lung
#blood subcompartment
dMBLu = CBfven *QBLu - (QBLu-QBLu/500)*CLuBf - PeffLu*ALu*(CLuBf-CLuFf) - CLuBf*QBLu/500
#interstitial fluid subcompartment
dMLuF = CLuBf*QBLu/500 - CLuFf*QBLu/500 + PeffLu*ALu*(CLuBf-CLuFf) - kLuFLuT*(CLuFf-CLuT)
#Lung tissue
dMLuT =  kLuFLuT*(CLuFf-CLuT) #- kLuTLuAF * (CLuAF-CLuT)
#Alveolar lining fluid
dMLuAF = 0 #kLuTLuAF * (CLuAF-CLuT) - Qp * CLuAF/PLungA + IVR*Cair*Cpfoa*dfalveolar
#Spleen
#blood subcompartment
dMBSP = QBSP*CBfart - (QBSP-QBSP/500)*CSPBf - PeffSP*ASP*(CSPBf-CSPFf) - CSPBf*QBSP/500
#interstitial fluid subcompartment
dMSPF = CSPBf*QBSP/500 - CSPFf*QBSP/500 + PeffSP*ASP*(CSPBf-CSPFf) - kSPFSPT*(CSPFf -CSPT)
#Spleen tissue subcompartment
dMSPT = kSPFSPT*(CSPFf -CSPT)
#Heart
#blood subcompartment
dMBH = QBH*CBfart - (QBH-QBH/500)*CHBf - PeffH*AH*(CHBf-CHFf) - CHBf*QBH/500
#interstitial fluid subcompartment
dMHF = CHBf*QBH/500 - CHFf*QBH/500 + PeffH*AH*(CHBf-CHFf) - kHFHT*(CHFf -CHT)
#Heart tissue subcompartment
dMHT = kHFHT*(CHFf -CHT)
#Brain
#blood subcompartment
dMBBr = QBBr*CBfart - (QBBr-QBBr/500)*CBrBf - PeffBr*ABr*(CBrBf-CBrFf) - CBrBf*QBBr/500
#interstitial fluid subcompartment
dMBrF = CBrBf*QBBr/500 - CBrFf*QBBr/500 + PeffBr*ABr*(CBrBf-CBrFf) - kBrFBrT*(CBrFf -CBrT)
#Brain tissue subcompartment
dMBrT = kBrFBrT*(CBrFf -CBrT)
#Testis
#blood subcompartment
dMBT = QBT*CBfart - (QBT-QBT/500)*CTBf - PeffT*AT*(CTBf-CTFf) - CTBf*QBT/500
#interstitial fluid subcompartment
dMTF = CTBf*QBT/500 - CTFf*QBT/500 + PeffT*AT*(CTBf-CTFf) - kTFTT*(CTFf -CTT)
#Testis tissue subcompartment
dMTT = kTFTT*(CTFf -CTT)
#Skin
#blood subcompartment
dMBSK = QBSK*CBfart - (QBSK-QBSK/500)*CSKBf - PeffSK*ASK*(CSKBf-CSKFf) - CSKBf*QBSK/500
#interstitial fluid subcompartment
dMSKF = CSKBf*QBSK/500 - CSKFf*QBSK/500 + PeffSK*ASK*(CSKBf-CSKFf) - kSKFSKT*(CSKFf -CSKT)
#Skin tissue subcompartment
dMSKT = kSKFSKT*(CSKFf -CSKT)
#Concentration calculation in each compartment
Cven <- CBven
Cart <- CBart
Cblood <- (MBven + MBart)/ (Vven+Vart)
Ckidney <- (MBK + MKF+ MKT)/(VKB+VKF+VKT)
Cliver <- (MBL + MLF+ MLT)/(VLB+VLF+VKT)
Cstomach <-  (MBST + MSTF+ MSTT)/(VSTB+VSTF+VSTT)
Cintestine <-  (MBIN + MINF+ MINT+MINL)/(VINB+VINF+VINT+VINL)
Cmuscle <-  (MBM + MMF+ MMT)/(VMB+VMF+VMT)
Cadipose <-  (MBA + MAF+ MAT)/(VAB+VAF+VAT)
Clungs <-  (MBLu + MLuF+ MLuT)/(VLuB+VLuF+VLuT)
Crest <-  (MBR + MRF+ MRT)/(VRB+VRF+VRT)
Ccarcass <- (MBM + MMF+ MMT+MBA + MAF+ MAT +MBR + MRF+ MRT)/(VM+VA+VR)
Cfeces <- CINL
Cbile <- Cbile
Curine <- CFil
Cspleen <-  (MBSP + MSPF+ MSPT)/(VSPB+VSPF+VSPT)
Cheart <-  (MBH + MHF+ MHT)/(VHB+VHF+VHT)
Cbrain <-  (MBBr + MBrF+ MBrT)/(VBrB+VBrF+VBrT)
Ctestis <-  (MBT + MTF+ MTT)/(VTB+VTF+VTT)
Cskin <-  (MBSK + MSKF+ MSKT)/(VSKB+VSKF+VSKT)
# Cven <- CBven
# Cart <- CBart
# Cblood <- (MBven + MBart)/ VB
# Ckidney <- (CKB*VKB + MKF+ MKT)/ VK
# Cliver <- (CLB*VLB + MLF+ MLT)/ VL
# Cstomach <-  (CSTB*VSTB + MSTF+ MSTT)/ VST
# Cintestine <-  (CINB*VINB+ MINT+MINL)/ VIN
# Cmuscle <-  (CMB*VMB + MMF+ MMT)/ VM
# Cadipose <-  (CAB*VAB + MAF+ MAT)/ VA
# Clungs <-  (CLuB*VLuB + MLuF+ MLuT)/ VLu
# Crest <-  (CRB*VRB + MRF+ MRT)/ VR
# Ccarcass <- (CMB*VMB + MMF + MMT + CAB*VAB + MAF+ MAT + CRB*VRB + MRF+ MRT)/(VM+VA+VR)
# Cfeces <- CINL
# Cbile <- Cbile
# Curine <- CFil
# Cspleen <-  (CSPB*VSPB + MSPF+ MSPT)/ VSP
# Cheart <-  (CHB*VHB + MHF+ MHT)/ VH
# Cbrain <-  (CBrB*VBrB + MBrF+ MBrT)/ VBr
# Ctestis <-  (CTB*VTB + MTF+ MTT)/ VT
# Cskin <-  (CSKB*VSKB + MSKF+ MSKT)/ VSK
list(c( 'dMBart'=dMBart, 'dMBven'=dMBven, 'dMLN'=dMLN, 'dMBK'=dMBK,
'dMKF'=dMKF, 'dMKT'=dMKT,
'dMFil'=dMFil, 'dMurine'=dMurine, 'dMBL'=dMBL,
'dMLF'=dMLF, 'dMLT'=dMLT, 'dMbile'=dMbile,
'dMSTL'=dMSTL,'dMINL'=dMINL,'dMfeces'=dMfeces,
'dMBST'=dMBST, 'dMSTF'=dMSTF, 'dMSTT'=dMSTT,
'dMBIN'=dMBIN, 'dMINF'=dMINF, 'dMINT'=dMINT,
'dMBM'=dMBM, 'dMMF'=dMMF, 'dMMT'=dMMT,
'dMBA'=dMBA, 'dMAF'=dMAF,
'dMAT'=dMAT, 'dMBR'=dMBR, 'dMRF'=dMRF,'dMRT'=dMRT,
'dMBLu'=dMBLu, 'dMLuF'=dMLuF,'dMLuT'=dMLuT,'dMLuAF' = dMLuAF,
'dMBSP'=dMBSP, 'dMSPF'=dMSPF, 'dMSPT'=dMSPT,
'dMBH'=dMBH, 'dMHF'=dMHF, 'dMHT'=dMHT,
'dMBBr'=dMBBr, 'dMBrF'=dMBrF, 'dMBrT'=dMBrT,
'dMBT'=dMBT, 'dMTF'=dMTF, 'dMTT'=dMTT,
'dMBSK'=dMBSK, 'dMSKF'=dMSKF, 'dMSKT'=dMSKT
),
'CKFf'=CKFf, 'CLNf'=CLNf, 'CLFf'=CLFf,
'CMFf'=CMFf,'CAFf'=CAFf, 'CRFf'=CRFf, 'CBfart'=CBfart,
'CKBf'=CKBf, 'CLBf'=CLBf, 'CMBf'=CMBf, 'CABf'=CABf,
'CRBf'=CRBf, 'CFil'=CFil, 'Cbile'=Cbile,
'Cfeces'=Cfeces, 'CKTf'=CKTf, 'CLTf'=CLTf,
'CSTL'=CSTL,'CINL'=CINL,
'CMT'=CMT, 'CAT'=CAT, 'CRT'=CRT,
# 'CKB'=CKB, 'CLB'=CLB, 'CSTB'=CSTB, 'CINB'=CINB, 'CMB'=CMB,
# 'CAB'=CAB, 'CLuB'=CLuB, 'CRB'=CRB, 'CSPB'=CSPB, 'CHB'=CHB,
# 'CBrB'=CBrB, 'CTB'=CTB, 'CSKB'=CSKB,
'Cven'=Cven, 'Cart' = Cart,'Cblood' = Cblood,
'Ckidney'=Ckidney, 'Cliver'=Cliver,
'Cstomach'=Cstomach, 'Cintestine'=Cintestine,
'Cmuscle'=Cmuscle, 'Cadipose'=Cadipose,
'Clungs' = Clungs, 'Crest'=Crest,'Ccarcass' = Ccarcass,
'Cfeces'=Cfeces, 'Cbile'=Cbile, 'Curine'=Curine,
'Cspleen'=Cspleen, 'Cheart'=Cheart, 'Cbrain'=Cbrain,
'Ctestis'=Ctestis, 'Cskin'=Cskin
)
})
}
#Initial condition for each compartment.
create.inits <- function(parameters){
with(as.list(parameters),{
MBart <- 0; MBven <-0;  MLN <-0; MBK <-0; MKF <-0; MKT <-0; MFil <-0; Murine <-0; MBL <-0
MLF <-0; MLT <-0; Mbile <-0;
MSTL <-0;  MINL <-0;
Mfeces <-0; MBST <-0; MSTF <-0; MSTT <-0; MBIN <-0; MINF <-0; MINT <-0;
MBM <-0; MMF <-0; MMT <-0; MBA <-0; MAF <-0
MAT <-0; MBR <-0; MRF <-0; MRT <-0; MLuAF<- 0;MBLu <- 0; MLuF <- 0;MLuT <- 0;
MBSP <-0; MSPF <-0; MSPT <-0; MBH <-0; MHF <-0; MHT <-0;
MBBr <-0; MBrF <-0; MBrT <-0; MBT <-0; MTF <-0; MTT <-0
MBSK <-0; MSKF <-0; MSKT <-0;
return(c('MBart'=MBart, 'MBven'=MBven, 'MLN'=MLN, 'MBK'=MBK, 'MKF'=MKF, 'MKT'=MKT,
'MFil'=MFil, 'Murine'=Murine, 'MBL'=MBL, 'MLF'=MLF, 'MLT'=MLT, 'Mbile'=Mbile,
'MSTL'=MSTL, 'MINL'=MINL, 'Mfeces'=Mfeces,
'MBST'=MBST, 'MSTF'=MSTF, 'MSTT'=MSTT,
'MBIN'=MBIN, 'MINF'=MINF, 'MINT'=MINT,
'MBM'=MBM, 'MMF'=MMF, 'MMT'=MMT,
'MBA'=MBA, 'MAF'=MAF, 'MAT'=MAT,
'MBR'=MBR, 'MRF'=MRF, 'MRT'=MRT,
'MBLu'=MBLu, 'MLuF'=MLuF,'MLuT'=MLuT, 'MLuAF' = MLuAF,
'MBSP'=MBSP, 'MSPF'=MSPF, 'MSPT'=MSPT,
'MBH'=MBH, 'MHF'=MHF, 'MHT'=MHT,
'MBBr'=MBBr, 'MBrF'=MBrF, 'MBrT'=MBrT,
'MBT'=MBT, 'MTF'=MTF, 'MTT'=MTT,
'MBSK'=MBSK, 'MSKF'=MSKF, 'MSKT'=MSKT
))
})
}
create.events <- function(parameters){
with(as.list(parameters), {
# Calculate number of administrated doses and corresponding administration time
ldose <- length(admin.dose)
ltimes <- length(admin.time)
# If not equal, then stop
if (ltimes != ldose){
stop("The times of administration should be equal in number to the doses")
}else{
if (admin.type == "iv"){
events <- list(data = rbind(data.frame(var = c("MBven"),  time = admin.time,
value = admin.dose, method = c("add")) ))
}else if (admin.type == "oral"){
events <- list(data = rbind(data.frame(var = c("MSTL"),  time = admin.time,
value = admin.dose, method = c("add")) ))
}
}
return(events)
})
}
#  absolute average fold error
AAFE <- function(predictions, observations, times=NULL){
y_obs <- unlist(observations)
y_pred <- unlist(predictions)
# Total number of observations
N <- length(y_obs)
log_ratio <- rep(NA, N)
for ( i in 1:N){
log_ratio[i] <- abs(log((y_pred[i]/y_obs[i]), base = 10))
}
aafe <- 10^(sum(log_ratio)/N)
return(aafe)
}
#  average fold error
AFE <- function(predictions, observations, times=NULL){
y_obs <- unlist(observations)
y_pred <- unlist(predictions)
# Total number of observations
N <- length(y_obs)
log_ratio <- rep(NA, N)
for ( i in 1:N){
log_ratio[i] <- (log((y_pred[i]/y_obs[i]), base = 10))
}
aafe <- 10^(sum(log_ratio)/N)
return(aafe)
}
#############################
#--------------------------
# Objective function
#-------------------------
obj.func <- function(x, dataset){
# x: a vector with the values of the optimized parameters (it is not the x
# from the odes!!!)
##########################
#-------------------------
# Kim ORAL male tissues
#-------------------------
##########################
# Set up simulations for the 4th case, i.e. kim (2016) ORAL male tissues
BW <- 0.25  # body weight (kg) not reported
admin.dose_per_g <- 1 # administered dose in mg PFOA/kg BW
admin.dose <- admin.dose_per_g*BW*1e03 #ug PFOA
admin.time <- 0 #time when doses are administered, in hours
admin.type <- "oral"
sex <- "M"
estimated_params <- exp(x)
user_input <- list('BW'=BW,
"admin.dose"= admin.dose,
"admin.time" = admin.time,
"admin.type" = admin.type,
"estimated_params" = estimated_params,
"sex" = sex)
params <- create.params(user_input)
inits <- create.inits(params)
events <- create.events(params)
# sample_time: a vector of time points to solve the ODEs
sample_time=seq(0,288,1)
# ode(): The solver of the ODEs
solution <- data.frame(deSolve::ode(times = sample_time,  func = ode.func,
y = inits, parms = params,
events = events,
method="lsodes",rtol = 1e-04, atol = 1e-04))
# We need to keep only the predictions for the relevant compartments for the time points
# at which we have available data.
exp_data <- dataset$df4 # retrieve data of kim (2016) ORAL male tissues
colnames(exp_data)[c(2,3)] <- c("time", "concentration")
preds_kim_OR_Mtissues <- solution[solution$time %in% unique(exp_data$time), c("Cliver","Ckidney",
"Clungs", "Cspleen", "Cheart" )]
preds_kim_OR_Mtissues<- preds_kim_OR_Mtissues /1000 #convert ug/kg to ug/g
obs_kim_OR_Mtissues <- c(exp_data[exp_data$Tissue == "Liver", "concentration"],
exp_data[exp_data$Tissue == "Kidney", "concentration"],
exp_data[exp_data$Tissue == "Lung", "concentration"],
exp_data[exp_data$Tissue == "Spleen", "concentration"],
exp_data[exp_data$Tissue == "Heart", "concentration"])
#Aggregate observations for all scenarios
preds <-c(preds_kim_OR_Mtissues)
obs <- c(obs_kim_OR_Mtissues)
score <- AAFE(predictions = preds, observations = obs)
return(score)
}
################################################################################
setwd("C:/Users/ptsir/Documents/GitHub/PFAS_PBK_models/PFOA inhalation Rat")
# Read data
kudo_high_dose <- openxlsx::read.xlsx("Data/IV_male_rats_tissues_high_kudo_2007.xlsx")
kudo_low_dose <- openxlsx::read.xlsx("Data/IV_male_rats_tissues_low_kudo_2007.xlsx")
kim_IV_Mtissues <- openxlsx::read.xlsx("Data/PFOA_male_tissues_IV_kim_2016.xlsx")
kim_OR_Mtissues <- openxlsx::read.xlsx("Data/PFOA_male_tissues_ORAL_kim_2016.xlsx")
kim_IV_Ftissues <- openxlsx::read.xlsx("Data/PFOA_female_tissues_IV_kim_2016.xlsx")
kim_OR_Ftissues <- openxlsx::read.xlsx("Data/PFOA_female_tissues_ORAL_kim_2016.xlsx")
dzi_OR_Mtissues <- openxlsx::read.xlsx("Data/Dzierlenga_tissue_male_ORAL_2021.xlsx")
dzi_OR_Ftissues <- openxlsx::read.xlsx("Data/Dzierlenga_tissue_female_ORAL_2021.xlsx")
kim_OR_Mblood <- openxlsx::read.xlsx("Data/PFOA_male_blood_ORAL_kim_2016.xlsx")
kim_IV_Mblood <- openxlsx::read.xlsx("Data/PFOA_male_blood_IV_kim_2016.xlsx")
Lup_OR_Ftissues <- openxlsx::read.xlsx("Data/PFOA_female_tissues_Lupton_2020.xlsx")
dataset <- list("df1" = kudo_high_dose, "df2" = kudo_low_dose, "df3" = kim_IV_Mtissues, "df4" = kim_OR_Mtissues,
"df5" = kim_IV_Ftissues, "df6" = kim_OR_Ftissues, "df7" = dzi_OR_Mtissues, "df8" = dzi_OR_Ftissues,
"df9" = kim_OR_Mblood, "df10" = kim_IV_Mblood, "df11" = Lup_OR_Ftissues)
#Initialise optimiser to NULL for better error handling later
opts <- list( "algorithm" = "NLOPT_LN_SBPLX",#"NLOPT_LN_NEWUOA","NLOPT_LN_SBPLX"
"xtol_rel" = 1e-07,
"ftol_rel" = 0.0,
"ftol_abs" = 0.0,
"xtol_abs" = 0.0 ,
"maxeval" = 200,
"print_level" = 1)
# Create initial conditions (zero initialisation)
#Parameter names:
# Male RAFOatp_k, Male RAFOat1, Male RAFOat3, Male RAFOatp_l,Male RAFNtcp
# Female RAFOatp_k, Female RAFOat1, Female RAFOat3, Female RAFOatp_l,female RAFNtcp
#  bile_correction_factor, 11 correction factors for permeabilities
N_pars <- 24# Number of parameters to be fitted
fit <- log(rep(1,N_pars))
# Run the optimization algorithmm to estimate the parameter values
optimizer <- nloptr::nloptr( x0= fit,
eval_f = obj.func,
#lb	= c(rep(log(1e-05), 6),rep(log(1e-02),N_pars-7),log(1e-05)),
#ub = c(rep(log(1e05), 6),rep(log(1e02), N_pars-7),log(1e05)),
opts = opts,
dataset = dataset)
estimated_params <- exp(optimizer$solution)
# Run the optimization algorithmm to estimate the parameter values
optimizer <- nloptr::nloptr( x0= fit,
eval_f = obj.func,
lb	= c(rep(log(1e-05), 6),rep(log(1e-02),N_pars-7),log(1e-05), log(1e-03)),
ub = c(rep(log(1e05), 6),rep(log(1e02), N_pars-7),log(1e05), log(1e03)),
opts = opts,
dataset = dataset)
estimated_params <- exp(optimizer$solution)
N_pars <- 24# Number of parameters to be fitted
fit <- log(rep(1,N_pars))
# Run the optimization algorithmm to estimate the parameter values
optimizer <- nloptr::nloptr( x0= fit,
eval_f = obj.func,
lb	= c(rep(log(1e-05), 6),rep(log(1e-02),N_pars-8),log(1e-05), log(1e-03)),
ub = c(rep(log(1e05), 6),rep(log(1e02), N_pars-8),log(1e05), log(1e03)),
opts = opts,
dataset = dataset)
estimated_params <- exp(optimizer$solution)
N_pars <- 24# Number of parameters to be fitted
fit <- log(rep(1,N_pars))
# Run the optimization algorithmm to estimate the parameter values
optimizer <- nloptr::nloptr( x0= fit,
eval_f = obj.func,
lb	= c(rep(log(1e-05), 6),rep(log(1e-02),N_pars-8),log(1e-05), log(1e-03)),
ub = c(rep(log(1e05), 6),rep(log(1e02), N_pars-8),log(1e05), log(1e03)),
opts = opts,
dataset = dataset)
estimated_params <- exp(optimizer$solution)
estimated_params
# Set up simulations for the 4th case, i.e. kim (2016) ORAL Male tissues
BW <- 0.25  # body weight (kg) not reported
admin.dose_per_g <- 1 # administered dose in mg PFOA/kg BW
admin.dose <- admin.dose_per_g*BW *1e03 #ug PFOA
admin.time <- 0 #time when doses are administered, in hours
admin.type <- "oral"
sex <- "M"
user_input <- list('BW'=BW,
"admin.dose"= admin.dose,
"admin.time" = admin.time,
"admin.type" = admin.type,
"estimated_params" = estimated_params,
"sex" = sex)
params <- create.params(user_input)
inits <- create.inits(params)
events <- create.events(params)
sample_time= c(0,0.0001, 0.0001, 0.001, 0.01, 0.1, seq(1,288,1))
solution <- data.frame(deSolve::ode(times = sample_time,  func = ode.func,
y = inits, parms = params,events = events,
method="lsodes",rtol = 1e-03, atol = 1e-03))
write.csv(solution[,1:50], file ="test.csv")
write.csv(solution[,1:50], file ="test.csv")
# Create a list containing the corresponding predictions
simulations <- list(predictions4 = preds_kim_OR_Mtissues)
# Iterate over all existing experiments and create the accompanying plots
for(i in 1:length(experiments)){
# Retrieve the corresponding observations and simulations
observations <- experiments[[i]]
predictions <- simulations[[i]]
# Extract the compartment names
compartments <- names(predictions)[2:length(predictions)]
# Use lapply to iterate over the column names and create plots
plots <- lapply(compartments, function(compartment) {
create.plots(predictions, observations, compartment )
})
final_plot <- do.call(ggpubr::ggarrange, c(plots, ncol = 3, nrow = ceiling(length(plots) / 3),
common.legend = TRUE, legend = "right"))
plot.margin=unit(c(0,0,0,0), "pt")
# Save the plot with dynamically adjusted dimensions
ggsave(paste0("experiment", i,".png"), plot = final_plot,
device = 'png', dpi = 300,
width = 13,
height = 10,
units = "in")
}
kKFKT
PeffK*AK
VKF
VmK_Oat3
(VmK_Oat3/KmK_Oat3+CKFf)*VKF
(VmK_Oat3/KmK_Oat3)*VKF
CKBf <- solution$CKBf
CKFf <-  solution$CKFf
CKTf <- solution$CKTf
in_blood <- CKBf*QBK/500
out_lymph <- - CKFf*QBK/500
dif_blood <- PeffK*AK*(CKBf-CKFf)
dif_tis<- - kKFKT*(CKFf-CKTf)
out_ota1<-    -(VmK_Oat1*CKFf/KmK_Oat1+CKFf)*VKF
out_oat2 <- - (VmK_Oat3*CKFf/KmK_Oat3+CKFf)*VKF
in_blood
out_lymph
dif_blood
dif_tis
CKFf
CKTf
CKFf
CKBf
CKFf
CKTf
out_ota1
out_oat2
VmK_Oat1
KmK_Oat1
KmK_Oat3
VmK_Oat3
